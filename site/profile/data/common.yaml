---
# Base settings
profile::base::linux::firewall_defaults:
  proto: 'tcp'
  action: 'accept'

# Puppet master settings
profile::puppet::master::pe_repo_platforms:
  - el_7_x86_64
  - ubuntu_1604_amd64
profile::puppet::master_of_masters::node_groups:
  'PE Master':
    ensure: present
    rule:
      - 'or'
      - ['and', ['~', ['trusted', 'certname'], '^puppet-compile-\d+\.openstack\.vm$']]
      - ['=', 'name', 'puppet-master-primary.openstack.vm']
  'PE ActiveMQ Broker':
    ensure: present
    classes:
      puppet_enterprise::profile::amq::broker:
        activemq_hubname: ['puppet-master-primary.openstack.vm']
    rule:
      - 'or'
      - ['and', ['~', ['trusted', 'certname'], '^puppet-compile-\d+\.openstack\.vm$']]
  'PE ActiveMQ Hub':
    ensure: present
    parent: 'PE Infrastructure'
    classes:
      puppet_enterprise::profile::amq::hub: {}
    rule:
      - 'or'
      - ['and', ['~', ['trusted', 'certname'], '^puppet-master-\w+\.openstack\.vm$']]
  'PE Infrastructure Agent':
    ensure: present
    classes:
      puppet_enterprise::profile::agent:
        manage_puppet_conf: true
        master_uris: ['puppet-master.openstack.vm']
        pcp_broker_list: ['puppet-master-primary.openstack.vm:8142']
        server_list: ['puppet-master-primary.openstack.vm:8140']
    data:
      puppet_enterprise::profile::mcollective::agent:
        activemq_brokers: ['puppet-master-primary.openstack.vm']
    rule:
      - 'or'
      - ['~', ['fact', 'pe_server_version'], '.+']
      - ['and', ['~', ['trusted', 'certname'], '^load-balancer-\d+\.openstack\.vm$']]
  'PE Agent':
    ensure: present
    classes:
      puppet_enterprise::profile::agent:
        manage_puppet_conf: true
        pcp_broker_list: ['puppet-master.openstack.vm:8142']
        server_list: ['puppet-master.openstack.vm:8140']
    data:
      puppet_enterprise::profile::mcollective::agent:
        activemq_brokers: ['puppet-master.openstack.vm']
    rule:
      - 'and'
      - ['~', ['fact', 'aio_agent_version'], '.+']

# Load balancer
profile::load_balancer::listeners:
  stats:
    collect_exported: false
    ipaddress: "%{::ipaddress_eth1}"
    ports: '9090'
    options:
      mode: 'http'
      stats: ['uri /', 'auth puppet:puppet']
  puppet00:
    collect_exported: true
    ipaddress: "%{::ipaddress_eth1}"
    ports: '8140'
    options:
      mode: 'tcp'
  orch00:
    collect_exported: true
    ipaddress: "%{::ipaddress_eth1}"
    ports: '8142'
    options:
      mode: 'tcp'
      timeout:
        - 'tunnel 15m'
      balance: 'leastconn'
  mco00:
    collect_exported: true
    ipaddress: "%{::ipaddress_eth1}"
    ports: '61613'
    options:
      mode: 'tcp'
      balance: 'source'
